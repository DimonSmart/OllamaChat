# Унификация архитектуры чата и улучшение стриминга

## Проблемы которые были решены

### 1. ✅ Унификация архитектуры
**Проблема**: Казалось, что есть две отдельные системы чата - обычный и многоагентный.

**Решение**: На самом деле архитектура уже была унифицирована! И обычный, и многоагентный чат используют один `ChatService` с `GroupChatOrchestration`. Единственное различие было в UI:
- `/chat` - для выбора одного агента
- `/multi-agent-chat` - для выбора нескольких агентов

### 2. ✅ Автоматический выбор координатора
**Улучшение**: Теперь координатор выбирается автоматически на основе количества агентов:

```csharp
// Автоматический выбор координатора в зависимости от количества агентов
_groupChatManager = _agentDescriptions.Count == 1
    ? new SingleAgentGroupChatManager()      // Для одного агента
    : new ReasonableRoundRobinGroupChatManager(...); // Для нескольких агентов
```

### 3. ✅ Улучшенный дебаунсинг стриминга
**Проблема**: Старая система использовала таймеры на основе времени, что могло приводить к проблемам с контекстом UI.

**Решение**: Новый `StreamingDebouncer`:
- Первое обновление происходит немедленно
- Последующие обновления дебаунсятся (100ms)
- Принудительное финальное обновление в конце стриминга
- Отсутствие смены контекста задач

### 4. ✅ Автоматическое определение параметров
**Улучшение**: UI теперь автоматически устанавливает правильные параметры:

**Для одного агента** (`/chat`):
- `maximumInvocationCount = 1`
- `stopAgentName = ""`
- `stopPhrase = ""`

**Для нескольких агентов** (`/multi-agent-chat`):
- `maximumInvocationCount = userDefined` (если > 1 агента)
- `stopAgentName = userDefined`
- `stopPhrase = userDefined`

## Новые компоненты

### `SingleAgentGroupChatManager`
Простой координатор для одного агента:
```csharp
internal sealed class SingleAgentGroupChatManager : RoundRobinGroupChatManager
{
    public override ValueTask<GroupChatManagerResult<bool>> ShouldTerminate(...)
    {
        // Всегда завершается после первого ответа
        return new ValueTask<GroupChatManagerResult<bool>>(
            new GroupChatManagerResult<bool>(true));
    }
}
```

### `StreamingDebouncer`
Умный дебаунсер для стриминга:
```csharp
public sealed class StreamingDebouncer : IDisposable
{
    public void TriggerUpdate()        // Первое обновление - немедленно
    public async Task FlushAsync()     // Принудительное финальное обновление
}
```

## Результат

1. **Стриминг работает корректно** как для одного, так и для нескольких агентов
2. **Нет дублирования кода** - единая архитектура для всех случаев  
3. **Улучшенный UX** - более плавный стриминг без задержек
4. **Автоматическая настройка** - UI сам выбирает правильные параметры
5. **Чистая архитектура** - соблюдение принципов Clean Architecture

## Backward Compatibility

✅ Все изменения обратно совместимы:
- Существующие агенты работают без изменений
- API не изменился
- UI остался прежним для пользователей
- Все тесты проходят
