@page "/system-prompts"
@using ChatClient.Shared.Models
@using ChatClient.Shared.Services
@using ChatClient.Api.Services
@inject ISystemPromptService AgentService
@inject ISnackbar Snackbar
@inject IOllamaClientService OllamaService
@inject KernelService KernelService

<PageTitle>Agents Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-3">
    <MudText Class="page-header">Agents</MudText>

    <MudPaper Elevation="3" Class="pa-3 rounded-lg">
        <MudToolBar Dense="true">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="AddNewAgent"
                       Class="px-4"
                       Size="Size.Small">
                Add Agent
            </MudButton>
            <MudSpacer />
            <MudTextField T="string"
                          ValueChanged="@(s => OnSearch(s))"
                          Placeholder="Search agents..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          IconSize="Size.Medium"
                          Class="mt-0"
                          Style="min-width: 300px;"
                          Immediate="true"
                          DebounceInterval="300" />
        </MudToolBar>

        @if (loading)
        {
            <MudStack Justify="Justify.Center" Class="my-4">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            </MudStack>
        }
        else
        {
            <MudDataGrid T="SystemPrompt" @ref="dataGrid"
                         Items="@filteredAgents"
                         ReadOnly="true"
                         Bordered="true"
                         Hover="true"
                         Striped="true"
                         Dense="true"
                         FixedHeader="true"
                         Height="100%"
                         Class="mt-4">
                <Columns>
                    <PropertyColumn Property="x => x.Name" Title="Name" SortBy="x => x.Name" />
                    <TemplateColumn Title="Display Name" isEditable="false">
                        <CellTemplate>
                            <div>
                                @if (!string.IsNullOrWhiteSpace(context.Item.AgentName))
                                {
                                    <MudChip T="string" Color="Color.Primary" Size="Size.Small">
                                        @context.Item.AgentName
                                    </MudChip>
                                }
                                else
                                {
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">Default</MudText>
                                }
                            </div>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Model" isEditable="false">
                        <CellTemplate>
                            <div>
                                @if (!string.IsNullOrWhiteSpace(context.Item.ModelName))
                                {
                                    <MudChip T="string" Color="Color.Secondary" Size="Size.Small">
                                        @context.Item.ModelName
                                    </MudChip>
                                }
                                else
                                {
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">Default</MudText>
                                }
                            </div>
                        </CellTemplate>
                    </TemplateColumn>
                    <PropertyColumn Property="x => x.UpdatedAt" Title="Updated" Format="g" />
                    <PropertyColumn Property="x => x.CreatedAt" Title="Created" Format="g" />
                    <TemplateColumn Title="Content" isEditable="false">
                        <CellTemplate>
                            <div>
                                <MudText Typo="Typo.body2" Class="mud-text-truncate">
                                    @context.Item.Content?.Substring(0, Math.Min(50, context.Item.Content?.Length ?? 0))@(context.Item.Content?.Length > 50 ? "..." : "")
                                </MudText>
                            </div>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn CellStyle="display:flex; justify-content:flex-end;">
                        <CellTemplate>
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Size="Size.Small"
                                           OnClick="@(() => StartEditingAgent(context.Item))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Size="Size.Small"
                                           Color="Color.Error"
                                           OnClick="() => ConfirmDeleteAgent(context.Item)" />
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
                <PagerContent>
                    <MudDataGridPager T="SystemPrompt" PageSizeOptions="new[] { 10, 25, 50, 100 }" />
                </PagerContent>
                <NoRecordsContent>
                    <MudPaper Elevation="0">
                        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Direction="Direction.Column" Class="py-8">
                            <MudIcon Icon="@Icons.Material.Filled.FormatQuote" Color="Color.Secondary" Size="Size.Large" />
                            <MudText Typo="Typo.h6" Class="mt-4">No agents found</MudText>
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">Click "Add Agent" to create one.</MudText>
                        </MudStack>
                    </MudPaper>
                </NoRecordsContent>
                <LoadingContent>
                    <MudPaper Elevation="0">
                        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Class="pa-8">
                            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Medium" />
                            <MudText Typo="Typo.body1" Class="ml-4">Loading agents...</MudText>
                        </MudStack>
                    </MudPaper>
                </LoadingContent>
            </MudDataGrid>
        }
    </MudPaper>
</MudContainer>

<MudDialog @bind-Visible="@showDeleteDialog" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Confirm Delete</MudText>
    </TitleContent>
    <DialogContent>
        <MudText>Are you sure you want to delete the agent "@agentToDelete?.Name"?</MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CancelDelete" Size="Size.Medium">Cancel</MudButton>
        <MudButton Color="Color.Error" OnClick="DeleteAgent" Size="Size.Medium">Delete</MudButton>
    </DialogActions>
</MudDialog>

<MudDialog @bind-Visible="@showEditAgentDialog" Options="editDialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">@(editingAgent?.Id == null ? "Create New Agent" : "Edit Agent")</MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="editAgentForm" Model="@editingAgent">
            <MudTextField @bind-Value="editingAgent.Name"
                          Label="Agent Name"
                          Required="true"
                          Immediate="true"
                          Validation="@(new Func<string, string>(ValidateName))" />

            <MudTextField @bind-Value="editingAgent.AgentName"
                          Label="Display Name (Optional)"
                          Class="mt-4"
                          Immediate="true"
                          HelperText="Custom display name for this agent. If empty, uses global agent name from settings."
                          Placeholder="Enter display name..." />

            <MudSelect T="string" @bind-Value="editingAgent.ModelName" Label="Model (Optional)" Class="mt-4" Dense="true" Clearable="true">
                @foreach (var model in availableModels)
                {
                    <MudSelectItem Value="@model.Name">@model.Name</MudSelectItem>
                }
            </MudSelect>
            <MudText Typo="Typo.caption">Leave blank to use chat's default model.</MudText>

            <div class="mt-4">
                <FunctionSelector AvailableFunctions="@availableFunctions"
                                   SelectedFunctions="@editingAgent.Functions"
                                   SelectedFunctionsChanged="@(v => editingAgent.Functions = v)"
                                   @bind-Expanded="functionsExpanded"
                                   AutoSelectFunctions="@editingAgent.AutoSelectFunctions"
                                   AutoSelectFunctionsChanged="@(v => editingAgent.AutoSelectFunctions = v)"
                                   AutoSelectCount="@editingAgent.AutoSelectCount"
                                   AutoSelectCountChanged="@(v => editingAgent.AutoSelectCount = v)" />
            </div>

            <MudTextField @bind-Value="editingAgent.Content"
                          Label="Agent Prompt"
                          Lines="10"
                          Class="mt-4"
                          Required="true"
                          Immediate="true"
                          Validation="@(new Func<string, string>(ValidateContent))"
                          Placeholder="Enter agent prompt content here..." />
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CancelEdit" Size="Size.Medium">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="SaveAgent" Size="Size.Medium">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<SystemPrompt> agents = new();
    private List<SystemPrompt> filteredAgents = new();
    private bool loading = true;
    private SystemPrompt? agentToDelete;
    private SystemPrompt editingAgent = new();
    private bool showDeleteDialog { get; set; } = false;
    private bool showEditAgentDialog { get; set; } = false;
    private string searchString = string.Empty;
    private MudForm? editAgentForm;
    private MudDataGrid<SystemPrompt>? dataGrid;
    private List<OllamaModel> availableModels = new();
    private List<FunctionInfo> availableFunctions = new();
    private bool functionsExpanded;
    private DialogOptions dialogOptions = new()
    {
        CloseOnEscapeKey = true,
        CloseButton = true,
        MaxWidth = MaxWidth.ExtraSmall
    };

    private DialogOptions editDialogOptions = new()
    {
        CloseOnEscapeKey = true,
        CloseButton = true,
        MaxWidth = MaxWidth.Medium,
        FullWidth = true
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadAgents();
        await LoadAvailableModels();
        await LoadAvailableFunctions();
    }

    private async Task LoadAgents()
    {
        try
        {
            loading = true;
            StateHasChanged();

            agents = await AgentService.GetAllPromptsAsync() ?? new();
            filteredAgents = agents;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading agents: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private async Task LoadAvailableModels()
    {
        try
        {
            availableModels = (await OllamaService.GetModelsAsync()).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading models: {ex.Message}", Severity.Error);
            availableModels = new();
        }
    }

    private async Task LoadAvailableFunctions()
    {
        try
        {
            availableFunctions = (await KernelService.GetAvailableFunctionsAsync()).ToList();
        }
        catch
        {
            availableFunctions = new();
        }
    }

    private void AddNewAgent()
    {
        editingAgent = new SystemPrompt
        {
            Id = null,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow,
            Name = "",
            Content = "",
            ModelName = null,
            Functions = new(),
            AutoSelectFunctions = false,
            AutoSelectCount = 0
        };

        showEditAgentDialog = true;
    }

    private void OnSearch(string text)
    {
        searchString = text;
        ApplySearch();
    }

    private void ApplySearch()
    {
        if (string.IsNullOrWhiteSpace(searchString))
        {
            filteredAgents = new List<SystemPrompt>(agents);
            return;
        }

        filteredAgents = agents
            .Where(p => p.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase) ||
                       p.Content.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            .ToList();
    }

    private Task StartEditingAgent(SystemPrompt agent)
    {
        editingAgent = new SystemPrompt
        {
            Id = agent.Id,
            Name = agent.Name,
            Content = agent.Content,
            AgentName = agent.AgentName,
            ModelName = agent.ModelName,
            CreatedAt = agent.CreatedAt,
            UpdatedAt = agent.UpdatedAt,
            Functions = new List<string>(agent.Functions),
            AutoSelectFunctions = agent.AutoSelectFunctions,
            AutoSelectCount = agent.AutoSelectCount
        };

        showEditAgentDialog = true;
        return Task.CompletedTask;
    }

    private void ConfirmDeleteAgent(SystemPrompt agent)
    {
        agentToDelete = agent;
        showDeleteDialog = true;
        StateHasChanged();
    }

    private void CancelDelete()
    {
        agentToDelete = null;
        showDeleteDialog = false;
    }

    private async Task DeleteAgent()
    {
        if (agentToDelete?.Id == null) return;
        try
        {
            await AgentService.DeletePromptAsync(agentToDelete.Id.Value);
            Snackbar.Add("Agent deleted successfully", Severity.Success);

            agents.Remove(agentToDelete);
            ApplySearch();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error deleting agent: {ex.Message}", Severity.Error);
        }

        agentToDelete = null;
        showDeleteDialog = false;
    }

    private string ValidateName(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "Name is required";

        if (name.Length < 3)
            return "Name must be at least 3 characters";

        return string.Empty;
    }

    private string ValidateContent(string content)
    {
        if (string.IsNullOrWhiteSpace(content))
            return "Content is required";

        if (content.Length < 10)
            return "Content must be at least 10 characters";

        return string.Empty;
    }

    private void CancelEdit()
    {
        showEditAgentDialog = false;
    }
    private async Task SaveAgent()
    {
        if (editAgentForm == null) return;
        await editAgentForm.Validate();
        if (editAgentForm.IsValid)
        {
            try
            {
                if (editingAgent.Id == null)
                {
                    var result = await AgentService.CreatePromptAsync(editingAgent);
                    agents.Add(result);
                    Snackbar.Add("Agent created successfully", Severity.Success);
                }
                else
                {
                    editingAgent.UpdatedAt = DateTime.UtcNow;
                    var result = await AgentService.UpdatePromptAsync(editingAgent);
                    var index = agents.FindIndex(p => p.Id == editingAgent.Id);
                    if (index >= 0) agents[index] = result;
                    Snackbar.Add("Agent updated successfully", Severity.Success);
                }

                showEditAgentDialog = false;
                ApplySearch();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error saving agent: {ex.Message}", Severity.Error);
            }
        }
    }
}
