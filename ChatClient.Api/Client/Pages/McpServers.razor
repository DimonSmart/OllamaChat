@page "/mcp-servers"
@using ChatClient.Domain.Models
@using ChatClient.Application.Services
@using ChatClient.Api.Services
@using ChatClient.Api.Services.BuiltIn
@inject IMcpServerConfigService McpServerConfigService
@inject IOllamaClientService OllamaService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>MCP Servers Management</PageTitle>
<OllamaCheck>
<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-3">
    <MudText Class="page-header">MCP Servers</MudText>

    <MudPaper Elevation="3" Class="pa-3 rounded-lg">
        <MudToolBar Dense="true">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="AddNewServer"
                       Class="px-4"
                       Size="Size.Small">
                Add Server
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Link"
                       OnClick="ShowInstallFromLinkDialog"
                       Class="ml-2 px-4"
                       Size="Size.Small">
                Install from Link
            </MudButton>
            <MudSpacer />
            <MudTextField T="string"
                          ValueChanged="@(s => OnSearch(s))"
                          Placeholder="Search servers..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          IconSize="Size.Medium"
                          Class="mt-0"
                          Style="min-width: 300px;"
                          Immediate="true"
                          DebounceInterval="300" />
        </MudToolBar>

        @if (loading)
        {
            <MudStack Justify="Justify.Center" Class="my-4">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            </MudStack>
        }
        else
        {
            <MudDataGrid T="IMcpServerDescriptor" @ref="dataGrid"
                         Items="@filteredServers"
                         ReadOnly="true"
                         Bordered="true"
                         Hover="true"
                         Striped="true"
                         Dense="true"
                         FixedHeader="true"
                         Height="100%"
                         Class="mt-4">
                <Columns>
                    <TemplateColumn Title="Name" isEditable="false">
                        <CellTemplate>
                            @{
                                var server = context.Item;
                            }
                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.body2">@server.Name</MudText>
                                @if (IsBuiltIn(server))
                                {
                                    <MudChip Size="Size.Small" Color="Color.Warning" Variant="Variant.Outlined">Built-in</MudChip>
                                }
                            </MudStack>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Updated" isEditable="false">
                        <CellTemplate>
                            @{
                                var updated = context.Item is McpServerConfig externalServer
                                    ? externalServer.UpdatedAt.ToLocalTime().ToString("g")
                                    : "-";
                            }
                            <MudText Typo="Typo.body2">@updated</MudText>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Created" isEditable="false">
                        <CellTemplate>
                            @{
                                var created = context.Item is McpServerConfig externalServer
                                    ? externalServer.CreatedAt.ToLocalTime().ToString("g")
                                    : "-";
                            }
                            <MudText Typo="Typo.body2">@created</MudText>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Type" isEditable="false">
                        <CellTemplate>
                            @{
                                var server = context.Item;
                                var type = GetServerType(server);
                            }
                            <MudChip Size="Size.Small" Color="@GetTypeChipColor(type)">
                                @type
                            </MudChip>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Configuration" isEditable="false">
                        <CellTemplate>
                            <div>
                                @{
                                    var server = context.Item;
                                    var configText = GetConfigurationText(server);
                                }
                                <MudText Typo="Typo.body2" Class="mud-text-truncate">
                                    @configText
                                </MudText>
                                @if (server is McpServerConfig externalServer && !string.IsNullOrEmpty(externalServer.SamplingModel))
                                {
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                        Sampling: @externalServer.SamplingModel
                                    </MudText>
                                }
                            </div>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn CellStyle="display:flex; justify-content:flex-end;">
                        <CellTemplate>
                            <MudIconButton Icon="@Icons.Material.Filled.PlayArrow"
                                         Size="Size.Small"
                                         OnClick="@(() => NavigateToPlayground(context.Item))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                         Size="Size.Small"
                                         Disabled="@(!CanModify(context.Item))"
                                         OnClick="@(() => StartEditing(context.Item))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                         Size="Size.Small"
                                         Color="Color.Error"
                                         Disabled="@(!CanModify(context.Item))"
                                         OnClick="() => ConfirmDelete(context.Item)" />
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
                <PagerContent>
                    <MudDataGridPager T="IMcpServerDescriptor" PageSizeOptions="new[] { 10, 25, 50, 100 }" />
                </PagerContent>
                <NoRecordsContent>
                    <MudPaper Elevation="0">
                        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Class="py-8">
                            <MudIcon Icon="@Icons.Material.Filled.Link" Color="Color.Secondary" Size="Size.Large" />
                            <MudText Typo="Typo.h6" Class="mt-4">No MCP servers found</MudText>
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">Click "Add Server" to create one.</MudText>
                        </MudStack>
                    </MudPaper>
                </NoRecordsContent>
                <LoadingContent>
                    <MudPaper Elevation="0">
                        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Class="pa-8">
                            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Medium" />
                            <MudText Typo="Typo.body1" Class="ml-4">Loading servers...</MudText>
                        </MudStack>
                    </MudPaper>
                </LoadingContent>
            </MudDataGrid>
        }
    </MudPaper>
</MudContainer>
</OllamaCheck>
<MudDialog @bind-Visible="@showDeleteDialog" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Confirm Delete</MudText>
    </TitleContent>
    <DialogContent>
        <MudText>Are you sure you want to delete the server "@serverToDelete?.Name"?</MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CancelDelete" Size="Size.Medium">Cancel</MudButton>
        <MudButton Color="Color.Error" OnClick="DeleteServer" Size="Size.Medium">Delete</MudButton>
    </DialogActions>
</MudDialog>

<MudDialog @bind-Visible="@showInstallFromLinkDialog" Options="installDialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Install MCP Server from Link</MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="installFromLinkForm">
            <MudTextField @bind-Value="installLink"
                         Label="VS Code MCP Link"
                         Required="true"
                         Immediate="true"
                         Validation="@(new Func<string, string>(ValidateInstallLink))"
                         Placeholder="Paste a vscode:mcp/install link" />
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CancelInstallFromLink" Size="Size.Medium">Cancel</MudButton>
        <MudButton Color="Color.Primary"
                   OnClick="InstallServerFromLink"
                   Disabled="@installInProgress"
                   Size="Size.Medium">
            Install
        </MudButton>
    </DialogActions>
</MudDialog>

<MudDialog @bind-Visible="@showEditServerDialog" Options="editDialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">@(editingServer?.Id == null ? "Create New Server" : "Edit Server")</MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="editServerForm" Model="@editingServer">
            <MudTextField @bind-Value="editingServer.Name"
                         Label="Server Name"
                         Required="true"
                         Immediate="true"
                         Validation="@(new Func<string, string>(ValidateName))" />

            <MudSelect T="string" 
                      Label="Server Type" 
                      @bind-Value="serverType" 
                      Required="true" 
                      Class="mt-4" 
                      Immediate="true"
                      SelectedValuesChanged="OnServerTypeChanged"
                      Dense="true">
                <MudSelectItem Value="@("local")">Local Command</MudSelectItem>
                <MudSelectItem Value="@("remote")">Remote SSE</MudSelectItem>
            </MudSelect>

            @if (serverType == "local")
            {
                <MudTextField @bind-Value="editingServer.Command"
                            Label="Command"
                            Class="mt-4"
                            Required="true"
                            Immediate="true"
                            Validation="@(new Func<string, string>(ValidateCommand))"
                            Placeholder="Enter the command to run (e.g. DimonSmart.NugetMcpServer)" />

                <MudTextField @bind-Value="argumentsText"
                            Label="Arguments (optional)"
                            Class="mt-4"
                            Immediate="true"
                            Placeholder="Enter command arguments, one per line" 
                            Lines="3" />
            }
            else
            {
                <MudTextField @bind-Value="editingServer.Sse"
                           Label="SSE URL"
                           Class="mt-4"
                           Required="true"
                           Immediate="true"
                           Validation="@(new Func<string, string>(ValidateSse))"
                           Placeholder="Enter SSE URL (e.g. https://mcp.llmtxt.dev/sse)" />
            }

            <MudSelect T="string"
                      Label="Sampling Model (Optional)"
                      @bind-Value="editingServer.SamplingModel"
                      Class="mt-4"
                      Clearable="true"
                      Placeholder="Select model for MCP sampling requests"
                      Dense="true">
                @foreach (var model in availableModels)
                {
                    <MudSelectItem Value="@model.Name">@model.Name</MudSelectItem>
                }
            </MudSelect>
            
            <MudText Typo="Typo.caption" Class="mud-text-secondary mt-1">
                If not specified, the user's default model will be used for sampling requests from this server.
            </MudText>
        </MudForm>    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CancelEdit" Size="Size.Medium">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="SaveServer" Size="Size.Medium">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<IMcpServerDescriptor> servers = new();
    private List<IMcpServerDescriptor> filteredServers = new();
    private List<OllamaModel> availableModels = new();
    private bool loading = true;
    private IMcpServerDescriptor? serverToDelete;
    private McpServerConfig editingServer = new();
    private bool showDeleteDialog { get; set; } = false;
    private bool showEditServerDialog { get; set; } = false;
    private bool showInstallFromLinkDialog;
    private string searchString = string.Empty;
    private MudForm? editServerForm;
    private MudForm? installFromLinkForm;
    private MudDataGrid<IMcpServerDescriptor>? dataGrid;
    private string serverType = "local";
    private string argumentsText = string.Empty;
    private string installLink = string.Empty;
    private bool installInProgress;

    private DialogOptions dialogOptions = new()
        {
            CloseOnEscapeKey = true,
            CloseButton = true,
            MaxWidth = MaxWidth.ExtraSmall
        };

    private DialogOptions installDialogOptions = new()
        {
            CloseOnEscapeKey = true,
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

    private DialogOptions editDialogOptions = new()
        {
            CloseOnEscapeKey = true,
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

    protected override async Task OnInitializedAsync()
    {
        await LoadServers();
        await LoadAvailableModels();
    }
    
    private async Task LoadAvailableModels()
    {
        try
        {
            availableModels = (await OllamaService.GetModelsAsync(Guid.Empty)).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Warning: Could not load available models: {ex.Message}", Severity.Warning);
            availableModels = [];
        }
    }

    private async Task LoadServers()
    {
        try
        {
            loading = true;
            StateHasChanged();

            servers = (await McpServerConfigService.GetAllAsync())
                .OrderByDescending(IsBuiltIn)
                .ThenBy(s => s.Name, StringComparer.OrdinalIgnoreCase)
                .ToList();
            filteredServers = new List<IMcpServerDescriptor>(servers);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading MCP servers: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private void OnServerTypeChanged(IEnumerable<string> values)
    {
        if (serverType == "local")
        {
            editingServer.Sse = null;
        }
        else
        {
            editingServer.Command = null;
            editingServer.Arguments = null;
            argumentsText = string.Empty;
        }
    }

    private void AddNewServer()
    {
        editingServer = new McpServerConfig
        {
            Id = null,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow,
            Name = "",
            IsBuiltIn = false,
            BuiltInKey = null,
            Command = ""
        };
        
        serverType = "local";
        argumentsText = string.Empty;
        showEditServerDialog = true;
    }

    private void ShowInstallFromLinkDialog()
    {
        installLink = string.Empty;
        showInstallFromLinkDialog = true;
        installFromLinkForm?.ResetValidation();
    }

    private void OnSearch(string text)
    {
        searchString = text;
        ApplySearch();
    }

    private void ApplySearch()
    {
        if (string.IsNullOrWhiteSpace(searchString))
        {
            filteredServers = new List<IMcpServerDescriptor>(servers);
            return;
        }

        filteredServers = servers
            .Where(s => s.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase) ||
                       (s is IBuiltInMcpServerDescriptor builtIn &&
                        builtIn.Key.Contains(searchString, StringComparison.OrdinalIgnoreCase)) ||
                       (s is McpServerConfig externalServer &&
                        ((externalServer.Command != null &&
                          externalServer.Command.Contains(searchString, StringComparison.OrdinalIgnoreCase)) ||
                         (externalServer.Sse != null &&
                          externalServer.Sse.Contains(searchString, StringComparison.OrdinalIgnoreCase)))))
            .ToList();
    }

    private void NavigateToPlayground(IMcpServerDescriptor server)
    {
        if (string.IsNullOrWhiteSpace(server.Name))
            return;

        var serverName = Uri.EscapeDataString(server.Name);
        NavigationManager.NavigateTo($"/mcp-playground?server={serverName}");
    }

    private void StartEditing(IMcpServerDescriptor server)
    {
        if (server is not McpServerConfig externalServer)
        {
            Snackbar.Add("Built-in MCP servers cannot be edited", Severity.Info);
            return;
        }

        editingServer = new McpServerConfig
        {
            Id = externalServer.Id,
            Name = externalServer.Name,
            IsBuiltIn = false,
            BuiltInKey = null,
            Command = externalServer.Command,
            Arguments = externalServer.Arguments,
            Sse = externalServer.Sse,
            SamplingModel = externalServer.SamplingModel,
            CreatedAt = externalServer.CreatedAt,
            UpdatedAt = externalServer.UpdatedAt
        };
        
        argumentsText = externalServer.Arguments != null 
            ? string.Join(Environment.NewLine, externalServer.Arguments) 
            : string.Empty;
            
        serverType = !string.IsNullOrEmpty(externalServer.Command) ? "local" : "remote";
        
        showEditServerDialog = true;
    }

    private void ConfirmDelete(IMcpServerDescriptor server)
    {
        if (server is not McpServerConfig)
        {
            Snackbar.Add("Built-in MCP servers cannot be deleted", Severity.Info);
            return;
        }

        serverToDelete = server;
        showDeleteDialog = true;
        StateHasChanged();
    }

    private void CancelDelete()
    {
        serverToDelete = null;
        showDeleteDialog = false;
    }

    private async Task DeleteServer()
    {
        if (serverToDelete is not McpServerConfig externalServer || externalServer.Id is not Guid serverId)
        {
            Snackbar.Add("Built-in MCP servers cannot be deleted", Severity.Info);
            showDeleteDialog = false;
            serverToDelete = null;
            return;
        }

        try
        {
            await McpServerConfigService.DeleteAsync(serverId);
            Snackbar.Add("Server deleted successfully", Severity.Success);

            servers.Remove(serverToDelete);
            ApplySearch();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error deleting server: {ex.Message}", Severity.Error);
        }

        serverToDelete = null;
        showDeleteDialog = false;
    }

    private void CancelInstallFromLink()
    {
        showInstallFromLinkDialog = false;
        installLink = string.Empty;
        installFromLinkForm?.ResetValidation();
    }

    private async Task InstallServerFromLink()
    {
        if (installFromLinkForm == null)
            return;

        await installFromLinkForm.Validate();
        if (!installFromLinkForm.IsValid)
            return;

        installInProgress = true;
        try
        {
            var installed = await McpServerConfigService.InstallFromLinkAsync(installLink.Trim());
            servers.Add(installed);
            ApplySearch();
            Snackbar.Add($"MCP server \"{installed.Name}\" installed successfully", Severity.Success);
            showInstallFromLinkDialog = false;
            installLink = string.Empty;
            installFromLinkForm?.ResetValidation();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to install MCP server: {ex.Message}", Severity.Error);
        }
        finally
        {
            installInProgress = false;
        }
    }

    private string ValidateName(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "Name is required";

        return string.Empty;
    }

    private string ValidateInstallLink(string link)
    {
        if (string.IsNullOrWhiteSpace(link))
            return "Link is required";

        return string.Empty;
    }

    private string ValidateCommand(string command)
    {
        if (serverType == "local" && string.IsNullOrWhiteSpace(command))
            return "Command is required for local servers";

        return string.Empty;
    }

    private string ValidateSse(string sse)
    {
        if (serverType == "remote" && string.IsNullOrWhiteSpace(sse))
            return "SSE URL is required for remote servers";

        if (serverType == "remote" && !string.IsNullOrWhiteSpace(sse))
        {
            if (!Uri.TryCreate(sse, UriKind.Absolute, out var uri) || 
                (uri.Scheme != "http" && uri.Scheme != "https"))
                return "Please enter a valid HTTP/HTTPS URL";
        }

        return string.Empty;
    }

    private void CancelEdit()
    {
        showEditServerDialog = false;
    }

    private async Task SaveServer()
    {
        if (editServerForm == null) return;
        if (editingServer.IsBuiltIn)
        {
            Snackbar.Add("Built-in MCP servers cannot be edited", Severity.Info);
            return;
        }

        await editServerForm.Validate();
        if (editServerForm.IsValid)
        {
            try
            {
                if (serverType == "local" && !string.IsNullOrWhiteSpace(argumentsText))
                {
                    var args = argumentsText.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
                    editingServer.Arguments = args.Length > 0 ? args : null;
                }
                else
                {
                    editingServer.Arguments = null;
                }

                if (editingServer.Id == null)
                {
                    await McpServerConfigService.CreateAsync(editingServer);
                    servers.Add(editingServer);
                    Snackbar.Add("MCP server created successfully", Severity.Success);
                }
                else
                {
                    editingServer.UpdatedAt = DateTime.UtcNow;
                    await McpServerConfigService.UpdateAsync(editingServer);
                    var index = servers.FindIndex(s => s.Id == editingServer.Id);
                    if (index >= 0) servers[index] = editingServer;
                    Snackbar.Add("MCP server updated successfully", Severity.Success);
                }

                showEditServerDialog = false;
                ApplySearch();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error saving MCP server: {ex.Message}", Severity.Error);
            }
        }
    }

    private static bool IsBuiltIn(IMcpServerDescriptor server) => server is IBuiltInMcpServerDescriptor;

    private static bool CanModify(IMcpServerDescriptor server) => server is McpServerConfig;

    private static string GetServerType(IMcpServerDescriptor server)
    {
        return server switch
        {
            IBuiltInMcpServerDescriptor => "Built-in",
            McpServerConfig externalServer when !string.IsNullOrEmpty(externalServer.Command) => "Local",
            McpServerConfig externalServer when !string.IsNullOrEmpty(externalServer.Sse) => "Remote",
            McpServerConfig => "Unknown",
            _ => "Unsupported"
        };
    }

    private static string GetConfigurationText(IMcpServerDescriptor server)
    {
        return server switch
        {
            IBuiltInMcpServerDescriptor builtIn => $"Built-in key: {builtIn.Key}",
            McpServerConfig externalServer when !string.IsNullOrEmpty(externalServer.Command) =>
                $"Command: {externalServer.Command}",
            McpServerConfig externalServer when !string.IsNullOrEmpty(externalServer.Sse) =>
                $"SSE: {externalServer.Sse}",
            McpServerConfig => "Configuration is not set",
            _ => "Unsupported server type"
        };
    }

    private static Color GetTypeChipColor(string type)
    {
        return type switch
        {
            "Built-in" => Color.Warning,
            "Local" => Color.Primary,
            _ => Color.Secondary
        };
    }
}
